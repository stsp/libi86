# Copyright (c) 2018 TK Chia
#
# This file is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program; see the file COPYING2.LIB.  If not see
# <http://www.gnu.org/licenses/>.

# Derived from libgloss/cr16/Makefile.in in Newlib.

DESTDIR =
VPATH = @srcdir@
srcdir = @srcdir@
objdir = .
srcroot = $(srcdir)/..
objroot = $(objdir)/..
mkinstalldirs = $(SHELL) $(srcroot)/mkinstalldirs

prefix = @prefix@
exec_prefix = @exec_prefix@

host_alias = @host_alias@

bindir = @bindir@
libdir = @libdir@
tooldir = $(exec_prefix)/$(target_alias)

INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

# Multilib support variables.
# TOP is used instead of MULTI{BUILD,SRC}TOP.
MULTIDIRS =
MULTISUBDIR =
MULTIDO = true
MULTICLEAN = true

SHELL =	/bin/sh

CC = @CC@

AS = @AS@
AR = @AR@
LD = @LD@
NM = @NM@
AWK = @AWK@
RANLIB = @RANLIB@
PACKAGE_VERSION = @PACKAGE_VERSION@

INSTALL_LIBS	= libi86.a
INSTALL_HEADERS	= bios.h \
		  conio.h \
		  dos.h \
		  dpmi.h \
		  graph.h \
		  i86.h \
		  libi86/stdlib.h \
		  libi86/string.h \
		  libi86/internal/cdefs.h \
		  libi86/internal/far-cxx.h \
		  libi86/internal/portio.h \
		  $(CLEAN_HEADERS)
CLEAN_HEADERS	= libi86/config.h \
		  libi86/internal/acconfig.h

OBJS		= bdos.o \
		  bios-disk.o \
		  bios-equiplist.o \
		  bios-joystick.o \
		  bios-keybrd.o \
		  bios-memsize.o \
		  bios-timeofday.o \
		  cgets.o \
		  clearscreen.o \
		  clreol.o \
		  clrscr.o \
		  cprintf.o \
		  cputs.o \
		  cscanf.o \
		  delay.o \
		  disable.o \
		  dos-allocmem.o \
		  dos-close.o \
		  dos-freemem.o \
		  dos-getdrive.o \
		  dos-getfileattr.o \
		  dos-setfileattr.o \
		  dpmi-hosted.o \
		  dpmigetdescriptor.o \
		  dpmisegmenttodescriptor.o \
		  dpmisimulaterealmodeint.o \
		  enable.o \
		  fmemcpy.o \
		  fmemmove.o \
		  fstrlen.o \
		  getch.o \
		  getche.o \
		  getdrive.o \
		  gettextposition.o \
		  getvideomode.o \
		  gotoxy.o \
		  highvideo.o \
		  inp.o \
		  inpw.o \
		  int86.o \
		  int86x.o \
		  intdos.o \
		  intdosx.o \
		  intr.o \
		  kbhit.o \
		  lowvideo.o \
		  nosound.o \
		  osmajor-osminor.o \
		  outmem.o \
		  outp.o \
		  outpw.o \
		  outtext.o \
		  psp.o \
		  putch.o \
		  scrolltextwindow.o \
		  segread.o \
		  settextposition.o \
		  settextwindow.o \
		  setvideomode.o \
		  sound.o \
		  textmode.o \
		  ungetch.o \
		  vcprintf.o \
		  vcscanf.o \
		  wherex.o \
		  wherey.o \
		  window.o \
		  libi86-bc-cgets.o \
		  libi86-bc-cprintf.o \
		  libi86-bc-cputs.o \
		  libi86-bc-cscanf.o \
		  libi86-bc-getche.o \
		  libi86-bc-putch.o \
		  libi86-bc-vcprintf.o \
		  libi86-bc-vcscanf.o \
		  libi86-bios-ds.o \
		  libi86-con-in-fd.o \
		  libi86-con-out-fd.o \
		  libi86-fmemmove-backward.o \
		  libi86-int86-do.o \
		  libi86-int86x-do.o \
		  libi86-intr-do.o \
		  libi86-intr-dispatch.o \
		  libi86-ret-really-set-errno.o \
		  libi86-ret-set-errno.o \
		  libi86-setvideomode-default.o \
		  libi86-setvideomode-nonsvga.o \
		  libi86-setvideomode-svga.o \
		  libi86-sound-by-divisor.o \
		  libi86-ungetch-buf.o \
		  libi86-vid-bc-outmem-do.o \
		  libi86-vid-state.o \
		  $(foreach da,0 1 2 3, \
		    $(foreach db,0 1 2 3 4 5 6 7, \
		      $(foreach dc,0 1 2 3 4 5 6 7, \
			libi86-intr-call-0$(da)$(db)$(dc).o)))
CFLAGS		= -mseparate-code-segment
ifeq "" "$(filter -O%,$(CC) $(CFLAGS) $(MULTILIB))"
  CFLAGS	+= -Os
endif
ASFLAGS		=
# Headers we depend on when creating .o files; these do not include
# libi86/config.h which is only generated after creating the library.
HEADERS		= $(filter-out libi86/config.h,$(INSTALL_HEADERS)) \
		  libi86/internal/arch.h \
		  libi86/internal/call-cvt.h \
		  libi86/internal/conio.h \
		  libi86/internal/graph.h \
		  libi86/internal/struc.h
BSP		= $(INSTALL_LIBS)

# Host specific makefile fragment comes in here.
@host_makefile_frag@

CPPFLAGS += $(INCLUDES) -I$(srcdir) -I.

.PHONY: default
default: all

.PHONY: all
all: $(INSTALL_LIBS) $(INSTALL_HEADERS)
	+@$(MULTIDO) $(FLAGS_TO_PASS) multi-do DO=$@

.PHONY: install
install: $(INSTALL_LIBS) $(INSTALL_HEADERS)
	$(mkinstalldirs) $(DESTDIR)$(tooldir)/lib$(MULTISUBDIR) \
			 $(DESTDIR)$(tooldir)/include \
			 $(DESTDIR)$(tooldir)/include/libi86 \
			 $(DESTDIR)$(tooldir)/include/libi86/internal
	set -e; \
	d=$(DESTDIR)$(tooldir)/lib$(MULTISUBDIR); \
	for f in $(INSTALL_LIBS); do \
	  if [ -f "$$f" ]; then \
	    $(INSTALL_DATA) "$$f" "$$d/$$f"; \
	  else \
	    $(INSTALL_DATA) $(srcdir)/"$$f" "$$d/$$f"; \
	  fi; \
	done
	set -e; \
	d=$(DESTDIR)$(tooldir)/include; \
	for f in $(INSTALL_HEADERS); do \
	  if [ -f "$$f" ]; then \
	    $(INSTALL_DATA) "$$f" "$$d/$$f"; \
	  else \
	    $(INSTALL_DATA) $(srcdir)/"$$f" "$$d/$$f"; \
	  fi; \
	done
	+@$(MULTIDO) $(FLAGS_TO_PASS) multi-do DO=$@

.PHONY: test doc info install-info clean-info
test doc info install-info clean-info:
	+@$(MULTIDO) $(FLAGS_TO_PASS) multi-do DO=$@

.PHONY: clean mostlyclean
clean mostlyclean: clean-here
	+@$(MULTICLEAN) $(FLAGS_TO_PASS) multi-clean DO=$@

.PHONY: clean-here
clean-here:
	$(RM) -f a.out core *.i *.o *-test *.srec *.dis *.x *.hex $(BSP) \
	  $(CLEAN_HEADERS)
	-rmdir libi86

.PHONY: distclean maintainer-clean realclean
distclean maintainer-clean realclean: clean
	+@$(MULTICLEAN) $(FLAGS_TO_PASS) multi-clean DO=$@
	rm -f Makefile config.cache config.log config.status *~

$(BSP): $(OBJS)
	$(RM) $@
	$(AR) rcs $@ $+

%.o: %.c $(HEADERS)
	$(CC) $(CPPFLAGS) -U_BORLANDC_SOURCE $(CFLAGS) $(MULTILIB) -c -o $@ $<

# We need this rule to override the next rule in case we do have a separate
# libi86-bc-*.c source file.
libi86-bc-%.o: libi86-bc-%.c $(HEADERS)
	$(CC) $(CPPFLAGS) $(CFLAGS) $(MULTILIB) -c -o $@ $<

libi86-bc-%.o: %.c $(HEADERS)
	$(CC) $(CPPFLAGS) -D_BORLANDC_SOURCE $(CFLAGS) $(MULTILIB) -c -o $@ $<

%.o: %.S $(HEADERS)
	$(CC) $(CPPFLAGS) -U_BORLANDC_SOURCE $(CFLAGS) $(ASFLAGS) $(MULTILIB) \
	  -c -o $@ $<

libi86-intr-call-%.o: libi86-intr-call.S $(HEADERS)
	$(CC) $(CPPFLAGS) -Dintr_no=$* $(CFLAGS) $(ASFLAGS) $(MULTILIB) -c \
	  -o $@ $<

libi86/config.h: make-config.sh $(BSP)
	mkdir -p $(@D)
	NM='$(NM)' AWK='$(AWK)' PACKAGE_VERSION='$(PACKAGE_VERSION)' \
	  $(SHELL) $< $(BSP) >$@.tmp
	mv $@.tmp $@

Makefile: Makefile.in config.status @host_makefile_frag_path@
	$(SHELL) config.status

config.status: configure
	$(SHELL) config.status --recheck
