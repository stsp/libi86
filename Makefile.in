# Copyright (c) 2018 TK Chia
#
# This file is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program; see the file COPYING3.LIB.  If not see
# <http://www.gnu.org/licenses/>.

abs_srcdir = @abs_srcdir@

default: all
.PHONY: default

distclean maintainer-clean:
	$(MAKE) -C ia16 $@
	$(MAKE) -C examples $@
	$(RM) Makefile config.cache config.log config.status
.PHONY: distclean maintainer-clean

check check-local: tests/testsuite
	exec $< -C tests $(TESTSUITEFLAGS)
.PHONY: check check-local

helpcheck: tests/testsuite
	exec $< -C tests --help $(TESTSUITEFLAGS)
.PHONY: helpcheck

listcheck: tests/testsuite
	exec $< -C tests --list $(TESTSUITEFLAGS)
.PHONY: listcheck

# Copy the generated tests/testsuite from the source directory to the build
# directory, or create a symlink from the latter to the former --- but only
# if the two directories are different.
tests/testsuite: $(abs_srcdir)/tests/testsuite
	set -e; \
	if test \! $@ -ef $<; then \
	  $(RM) $@.tmp; \
	  ln -s $< $@.tmp || cp $< $@.tmp; \
	  mv $@.tmp $@; \
	fi

$(abs_srcdir)/tests/testsuite: $(abs_srcdir)/tests/testsuite.at \
			   $(wildcard $(abs_srcdir)/tests/*.at)
	cd $(abs_srcdir)/tests && exec autom4te --language=autotest -o $@ $<

%:
	$(MAKE) -C ia16 $@
	$(MAKE) -C examples $@
.PHONY: %
